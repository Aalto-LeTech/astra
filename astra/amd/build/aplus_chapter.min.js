define(["jquery","core/event","mod_astra/aplus_poll","theme_boost/dropdown","mod_astra/aplus_modal"],function(e,t){var s;return function(e,t,s,i,a){"use strict";var n={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",active_element_attr:"data-aplus-active-element",loading_selector:"#loading-indicator",quiz_success_selector:"#quiz-success",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},modal_selector:"#page-modal"};function r(t,s){this.dom_element=t,this.element=e(t),this.settings=e.extend({},n,s),this.ajaxForms=!1,this.url=null,this.modalElement=null,this.loader=null,this.messages=null,this.quizSuccess=null,this.aeOutputs={},this.init()}e.extend(r.prototype,{init:function(){this.ajaxForms=!!s.FormData,this.url=this.element.attr(this.settings.chapter_url_attr),this.modalElement=e(this.settings.modal_selector),this.loader=e(this.settings.loading_selector),this.messages=this.readMessages(),this.quizSuccess=e(this.settings.quiz_success_selector),this.element.find("["+this.settings.active_element_attr+"='in']").aplusExercise(this,{input:!0});const t=this.element.find("["+this.settings.exercise_url_attr+"]");if(t.length>0)this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-loaded",{bubbles:!0})),t.aplusExercise(this),this.exercises=t,this.exercisesIndex=0,this.exercisesSize=t.length,this.nextExercise();else{const e="text/x.aplus-exercise";this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:e}})),this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:e}}))}},nextExercise:function(){this.exercisesIndex<this.exercisesSize&&(this.exercises.eq(this.exercisesIndex).aplusExerciseLoad(),this.exercisesIndex++),this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-ready",{bubbles:!0}))},readMessages:function(){var e={};for(var t in this.settings.message_attr)e[t]=this.loader.attr(this.settings.message_attr[t]);return e},cloneLoader:function(t){return e(this.settings.loading_selector).clone().removeAttr("id").show()},openModal:function(e){this.modalElement.aplusModal("open",e)},modalError:function(e){this.modalElement.aplusModal("error",e)},modalContent:function(e){this.modalElement.aplusModal("content",{content:e}),this.renderMath()},modalSuccess:function(e,t){var s=this.quizSuccess.clone().attr("class",e.attr("class")).removeClass("exercise").removeAttr("id").show();s.find(".badge-placeholder").empty().append(t),t.hasClass("badge-success")||t.hasClass("badge-warning")?s.find(".btn-success").css("display","block"):s.find(".btn-success").hide(),this.modalContent(s)},renderMath:function(){t.notifyFilterContentUpdated(this.settings.modal_selector)}}),e.fn.aplusChapter=function(t){return this.each(function(){e.data(this,"plugin_aplusChapter")||e.data(this,"plugin_aplusChapter",new r(this,t))})}}(e,t,window,document),function(e,t,s,i,a){"use strict";var n={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",content_element:'<div class="exercise-content"></div>',content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:'ul.exercise-nav a[class!="dropdown-toggle"]',dropdown_selector:"ul.exercise-nav .dropdown-toggle",last_submission_selector:"ul.exercise-nav .dropdown-menu a:first-child",active_element_attr:"data-aplus-active-element",ae_result_selector:".ae_result",input:!1,submission_point_badges_selector:"[data-points-badge] .badge"};function r(t,s,i){this.dom_element=t,this.element=e(t),this.chapter=s,this.settings=e.extend({},n,i),this.url=null,this.quiz=!1,this.ajax=!1,this.active_element=!1,this.loader=null,this.messages={},this.init()}e.extend(r.prototype,{init:function(){if(this.chapterID=this.element.attr("id"),this.url=this.element.attr(this.chapter.settings.exercise_url_attr),this.quiz=void 0!==this.element.attr(this.settings.quiz_attr),this.ajax=void 0!==this.element.attr(this.settings.ajax_attr),this.active_element=void 0!==this.element.attr(this.settings.active_element_attr),this.exercise_type=this.quiz?"text/x.aplus-exercise.quiz.v1":this.ajax?"text/x.aplus-exercise.iframe.v1":this.active_element?"text/x.aplus-exercise.active-element.v1":"text/x.aplus-exercise",this.active_element&&!this.settings.input&&(this.chapter.aeOutputs[this.chapterID]=this),this.loader=this.chapter.cloneLoader(),this.element.height(this.element.height()).empty(),this.element.append(this.settings.content_element),this.element.append(this.loader),this.settings.input&&this.load(),!this.active_element&&this.ajax){var t=this;s.addEventListener("message",function(s){"a-plus-refresh-stats"===s.data.type&&e.ajax(t.url,{dataType:"html"}).done(function(s){t.updateSummary(e(s))})})}},makeInputForm:function(t,s,i,a){var n=e("<div>");n.attr("id","exercise-all");var r=e("<form>");r.attr("action",""),r.attr("method","post");var l=e("<div>");l.attr("class","form-group");var o,d=e("<label>");if(d.attr("class","control-label"),d.attr("for",t+"_input"),d.html(s),i&&"clickable"!==i){if("file"===i)(o=e("<input>")).attr("type","file"),r.attr("enctype","multipart/form-data");else if("dropdown"==i.substring(0,8)){o=e("<select>");var c=i.split(":").pop().split(",");e.each(c,function(t,s){var i=e("<option>");i.text(s),i.val(s),o.append(i)})}}else(o=e("<textarea>")).val(a);o.attr("class","form-control"),o.attr("id",t+"_input_id"),o.attr("name",t+"_input");var u=e("<div>");l.attr("class","form-group");var h=e("<input>");return h.attr("class","btn btn-primary"),h.attr("value","Submit"),h.attr("type","submit"),e(l).append(d,o),e(u).append(h),e(r).append(l,u),e(n).append(r),e(n)},load:function(t){this.showLoader("load");var s=this;if(s.settings.input){var i=s.element.data("title"),a=s.element.data("type"),n=s.element.data("default");i||(i=""),n||(n=""),s.hideLoader();var r=s.makeInputForm(s.chapterID,i,a,n);s.update(r),s.loadLastSubmission(r),t||s.chapter.nextExercise()}else e.ajax(this.url,{dataType:"html"}).fail(function(){s.showLoader("error"),t||s.chapter.nextExercise()}).done(function(i){s.hideLoader(),s.update(e(i)),s.quiz||s.active_element?s.loadLastSubmission(e(i)):(s.renderMath(),t||s.chapter.nextExercise())})},update:function(t){t=t.filter(this.settings.exercise_selector).contents();var s=this.element.find(this.settings.content_selector).empty().append(t).hide();if(this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:this.exercise_type}})),this.active_element){var i="";this.element.attr("data-title")&&(i="<p><b>"+this.element.attr("data-title")+"</b></p>"),this.element.find(this.settings.summary_selector).remove(),e(i).prependTo(this.element.find(this.settings.response_selector))}s.show();var a=this.element.css("height");if(this.active_element)if(this.settings.input)e("#"+this.chapterID+" textarea").css("height",a);else if(void 0!==e("#"+this.chapterID).data("scale")){var n=e(this.settings.ae_result_selector,this.element)[0].scrollHeight;e(this.settings.ae_result_selector,this.element).css({height:n+"px"})}else e(this.settings.ae_result_selector,this.element).css("height",a);this.element.height("auto"),this.bindNavEvents(),this.bindFormEvents(s),this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:this.exercise_type}}))},bindNavEvents:function(){this.element.find(this.settings.navigation_selector).aplusModalLink(),this.element.find(this.settings.dropdown_selector).dropdown(),this.element.find(".page-modal").aplusModalLink()},bindFormEvents:function(e){if(!this.ajax){var t=e.find("form").attr("action",this.url),i=this;this.chapter.ajaxForms&&t.on("submit",function(e){e.preventDefault(),i.submit(this)})}s.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submitAjax:function(t,s,i,a){var n=this;e.ajax(t,{type:"POST",data:s,contentType:!1,processData:!1,dataType:"html"}).fail(function(r,l,o){if(a=a||0,200!==r.status&&a<5&&setTimeout(function(){n.submitAjax(t,s,i,a+1)},100),n.active_element){var d=e("<div>");d.attr("id","feedback"),d.append(n.chapter.messages.error),n.updateOutput(d)}else n.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:n.exercise_type}})),n.chapter.modalError(n.chapter.messages.error)}).done(function(e){i(e)})},collectFormData:function(t,s){t=e(t);var[i,a,n]=this.matchInputs(t),r=new FormData,l=this.chapterID,o=!0;return e.each(a,function(t,s){var i,a=e.find("#"+s),d=e("#"+s+"_input_id");if(a[0].hasAttribute("data-inputs")){if(e(a).data("evaluating"))return o=!1,void(r=!1);i=e(a).find(".ae_result").text().trim()}else"file"===e(a).data("type")?i=d.get(0).files[0]:s!==l?(i=d.val(),e(a).data("value")&&(i=e(a).data("value")),d.val(i)):(i=d.val(),e(a).data("value",i));i||(o=!1),r&&r.append(n[t],i)}),[i,o,r]},submit:function(t){var s=this,i=this.chapter;if(this.active_element){var a=this.chapterID,n=e.find('[data-inputs~="'+a+'"]');e.each(n,function(i,a){var[n,r,l]=s.collectFormData(a,t),o=n.chapterID,d=e("#"+o),c=d.find(n.settings.ae_result_selector);if(r||l){if(!r)return e("#"+o).find(n.settings.ae_result_selector).html('<p style="color:red;">Fill out all the inputs</p>'),void s.dom_element.dispatchEvent(new CustomEvent("aplus:submission-aborted",{bubbles:!0,detail:{type:s.exercise_type}}));d.data("evaluating",!0),void 0!==d.data("scale")&&c.css({height:c.height()}),c.html("<p>Evaluating</p>");var u=n.url;n.submitAjax(u,l,function(t){var s=e(t);if(s.find(".alert-danger").length)s.find(".alert-danger").contents().text().indexOf("The grading queue is not configured.")>=0?(d.find(n.settings.ae_result_selector).html(s.find(".alert").text()),d.find(n.settings.ae_result_selector).append(s.find(".grading-task").text())):d.find(n.settings.ae_result_selector).html(s.find(".alert-danger").contents());else{var i=s.find(".exercise-wait"),a=i.attr("data-poll-url"),r=i.attr("data-ready-url");d.attr("data-poll-url",a),d.attr("data-ready-url",r),n.updateSubmission(s)}})}})}else{i.openModal(i.messages.submit);var r=this,l=e(t).attr("action"),o=new FormData(t);r.submitAjax(l,o,function(t){var s=e(t);if(r.quiz){var a=s.find(".badge").eq(2).clone();r.update(s),i.modalSuccess(r.element,a),r.renderMath(),r.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:r.exercise_type}}))}else r.updateSubmission(s)})}},matchInputs:function(t){var s=t.attr("id"),i=this.chapter.aeOutputs[s],a=t.attr("data-inputs").split(" "),n=t.find(i.settings.ae_result_selector).attr("data-expected-inputs");return n?(n=n.trim().split(" "),n=e.grep(n,function(e){return""!==e||"\n"!==e})):n=[],[i,a,n]},updateSummary:function(e){this.element.find(this.settings.summary_selector).empty().append(e.find(this.settings.summary_selector).remove().contents()),this.bindNavEvents()},updateSubmission:function(t){if(this.active_element||(this.updateSummary(t),this.chapter.modalContent(t.filter(this.settings.exercise_selector).contents())),"function"==typeof e.aplusExerciseDetectWaits){var s,i=this;this.active_element&&(s="#"+this.chapterID),e.aplusExerciseDetectWaits(function(t,s){s?i.active_element?i.dispatchEventToActiveElem("aplus:exercise-submission-failure"):(i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:i.exercise_type}})),i.load(!0)):e.ajax(t).done(function(t){if(i.active_element)i.updateOutput(t),i.dispatchEventToActiveElem("aplus:submission-finished"),i.submit();else{var s=e(t),a=s.find(i.settings.submission_point_badges_selector),n=i.element.find(i.settings.summary_selector+" .badge");n.eq(0).replaceWith(a.eq(0).clone()),n.eq(2).replaceWith(a.eq(1).clone());var r=s.filter(i.settings.exercise_selector).contents();""==r.text().trim()?i.chapter.modalSuccess(i.element,a.eq(1).clone()):i.chapter.modalContent(r),i.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:i.exercise_type}})),i.load(!0)}}).fail(function(){i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:i.exercise_type}})),i.chapter.modalError(i.chapter.messages.error),i.load(!0)})},s)}},updateOutput:function(t){var s=this.element.attr("data-type")||"text",i=e(t);i.is("#feedback")||(i=i.find("#feedback")),"text"==s?i=i.text():"image"==s&&(i='<img src="data:image/png;base64, '+i.text()+'" />');var a=this.element.find(this.settings.ae_result_selector);a.html(i),this.element.data("evaluating",!1),void 0!==this.element.data("scale")&&a.css({height:"auto"})},updateInputs:function(t){t=t.submission_data;var[s,i,a]=this.matchInputs(this.element);for(var n in t)if(t.hasOwnProperty(n)){var r=n,l=i[e.inArray(r,a)],o=t[n];"file"!==e("#"+l).data("type")&&(e(e.find("#"+l)).data("value",o),e("#"+l+"_input_id").val(o).trigger("change"))}},dispatchEventToActiveElem:function(t){this.dom_element.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:{type:this.exercise_type}}));const[,s]=this.matchInputs(this.element);for(const i of s){const s=e("#"+i).data("plugin_aplusExercise");s&&s.dom_element.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:{type:s.exercise_type}}))}},loadLastSubmission:function(t){var s=t.find(this.settings.last_submission_selector),i=this;if(s.length>0){var a=s.attr("href");if(a&&"#"!==a){var n="html";if(i.active_element){var r=a.match(/submission\.php\?id=(\d+)$/);r?(a="submission_data.php?id="+r[1],n="json"):console.error("Can not read the submission data URL")}this.showLoader("load"),e.ajax(a,{dataType:n}).fail(function(){i.showLoader("error")}).done(function(t){if(i.hideLoader(),i.active_element)i.updateOutput(t.feedback),i.updateInputs(t);else{i.element.find(i.settings.response_selector).empty().append(e(t).filter(i.settings.exercise_selector).contents());i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:i.exercise_type}})),i.bindFormEvents(i.element),i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:i.exercise_type}}))}i.renderMath()})}else i.renderMath()}i.chapter.nextExercise()},showLoader:function(e){this.loader.show().find(this.settings.message_selector).text(this.chapter.messages[e]),"error"==e?this.loader.removeClass("progress-bar-animated").addClass("bg-danger"):this.loader.addClass("progress-bar-animated").removeClass("bg-danger")},hideLoader:function(){this.loader.hide()},renderMath:function(){t.notifyFilterContentUpdated("#"+this.element.attr("id"))}}),e.fn.aplusExercise=function(t,s){return this.each(function(){e.data(this,"plugin_aplusExercise")||e.data(this,"plugin_aplusExercise",new r(this,t,s))})},e.fn.aplusExerciseLoad=function(){return this.each(function(){var t=e.data(this,"plugin_aplusExercise");t&&t.load()})}}(e,t,window,document),(s=e)(document).on("aplus:exercise-loaded",function(e){s(e.target).find("form").each(function(){const e=s(this);"post"==e.prop("method")&&e.on("submit",function(e){s(this).find('[type="submit"]').prop("disabled",!0).attr("data-aplus-submit-disabled","yes")})})}),s(document).on("aplus:exercise-submission-failure aplus:submission-finished aplus:submission-aborted",function(e){s(e.target).find("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")}),s(document).on("hidden.bs.modal",function(e){s("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")}),{}});