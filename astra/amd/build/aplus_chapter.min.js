define(["jquery","core/event","mod_astra/aplus_poll","theme_boost/dropdown","mod_astra/aplus_modal"],function(a,b){return function(a,b,c,d,e){function f(b,c){this.element=a(b),this.settings=a.extend({},h,c),this.ajaxForms=!1,this.url=null,this.modalElement=null,this.loader=null,this.messages=null,this.quizSuccess=null,this.aeOutputs={},this.init()}var g="aplusChapter",h={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",active_element_attr:"data-aplus-active-element",loading_selector:"#loading-indicator",quiz_success_selector:"#quiz-success",message_selector:".progress-bar",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},modal_selector:"#page-modal"};a.extend(f.prototype,{init:function(){this.ajaxForms=!!c.FormData,this.url=this.element.attr(this.settings.chapter_url_attr),this.modalElement=a(this.settings.modal_selector),this.loader=a(this.settings.loading_selector),this.messages=this.readMessages(),this.quizSuccess=a(this.settings.quiz_success_selector),this.element.find("["+this.settings.active_element_attr+"='in']").aplusExercise(this,{input:!0}),this.exercises=this.element.find("["+this.settings.exercise_url_attr+"]").aplusExercise(this),this.exercisesIndex=0,this.exercisesSize=this.exercises.length,this.exercisesSize>0&&this.nextExercise()},nextExercise:function(){this.exercisesIndex<this.exercisesSize&&(this.exercises.eq(this.exercisesIndex).aplusExerciseLoad(),this.exercisesIndex++)},readMessages:function(){var a={};for(var b in this.settings.message_attr)a[b]=this.loader.attr(this.settings.message_attr[b]);return a},cloneLoader:function(b){return a(this.settings.loading_selector).clone().removeAttr("id").show()},openModal:function(a){this.modalElement.aplusModal("open",a)},modalError:function(a){this.modalElement.aplusModal("error",a)},modalContent:function(a){this.modalElement.aplusModal("content",{content:a}),this.moodleNotifyFilterContentUpdatedInModal()},modalSuccess:function(b,c){this.modalElement.one("hidden.bs.modal",function(c){a(d.body).animate({scrollTop:b.offset().top},300)});var e=this.quizSuccess.clone().attr("class",b.attr("class")).removeClass("exercise").removeAttr("id").show();e.find(".badge-placeholder").empty().append(c),c.hasClass("badge-success")||c.hasClass("badge-warning")?e.find(".btn-success").css("display","block"):e.find(".btn-success").hide(),this.modalContent(e)},moodleNotifyFilterContentUpdatedInModal:function(){b.notifyFilterContentUpdated(this.settings.modal_selector)}}),a.fn[g]=function(b){return this.each(function(){a.data(this,"plugin_"+g)||a.data(this,"plugin_"+g,new f(this,b))})}}(a,b,window,document),function(a,b,c,d,e){function f(b,c,d){this.element=a(b),this.chapter=c,this.settings=a.extend({},i,d),this.url=null,this.quiz=!1,this.ajax=!1,this.active_element=!1,this.loader=null,this.messages={},this.init()}var g="aplusExercise",h="aplusExerciseLoad",i={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",content_element:'<div class="exercise-content"></div>',content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:'ul.exercise-nav a[class!="dropdown-toggle"]',dropdown_selector:"ul.exercise-nav .dropdown-toggle",last_submission_selector:"ul.exercise-nav .dropdown-menu a:first-child",active_element_attr:"data-aplus-active-element",ae_result_selector:".ae_result",input:!1,submission_point_badges_selector:"[data-points-badge] .badge"};a.extend(f.prototype,{init:function(){if(this.chapterID=this.element.attr("id"),this.url=this.element.attr(this.chapter.settings.exercise_url_attr),this.quiz=this.element.attr(this.settings.quiz_attr)!==e,this.ajax=this.element.attr(this.settings.ajax_attr)!==e,this.active_element=this.element.attr(this.settings.active_element_attr)!==e,this.active_element&&!this.settings.input&&(this.chapter.aeOutputs[this.chapterID]=this),this.loader=this.chapter.cloneLoader(),this.element.height(this.element.height()).empty(),this.element.append(this.settings.content_element),this.element.append(this.loader),this.settings.input&&this.load(),!this.active_element&&this.ajax){var b=this;c.addEventListener("message",function(c){"a-plus-refresh-stats"===c.data.type&&a.ajax(b.url,{dataType:"html"}).done(function(c){b.updateSummary(a(c))})})}},makeInputForm:function(b,c,d,e){var f=a("<div>");f.attr("id","exercise-all");var g=a("<form>");g.attr("action",""),g.attr("method","post");var h=a("<div>");h.attr("class","form-group");var i=a("<label>");i.attr("class","control-label"),i.attr("for",b+"_input"),i.html(c);var j;if(d){if("file"===d)j=a("<input>"),j.attr("type","file"),g.attr("enctype","multipart/form-data");else if("dropdown"==d.substring(0,8)){j=a("<select>");var k=d.split(":").pop().split(",");a.each(k,function(b,c){var d=a("<option>");d.text(c),d.val(c),j.append(d)})}}else j=a("<textarea>"),j.val(e);j.attr("class","form-control"),j.attr("id",b+"_input_id"),j.attr("name",b+"_input");var l=a("<div>");h.attr("class","form-group");var m=a("<input>");return m.attr("class","btn btn-primary"),m.attr("value","Submit"),m.attr("type","submit"),a(h).append(i,j),a(l).append(m),a(g).append(h,l),a(f).append(g),a(f)},load:function(){this.showLoader("load");var b=this;if(b.settings.input){var c=b.element.data("title"),d=b.element.data("type"),e=b.element.data("default");c||(c=""),e||(e=""),b.hideLoader();var f=b.makeInputForm(b.chapterID,c,d,e);b.update(f),b.loadLastSubmission(f),b.chapter.nextExercise()}else a.ajax(this.url,{dataType:"html"}).fail(function(){b.showLoader("error"),b.chapter.nextExercise()}).done(function(c){b.hideLoader(),b.update(a(c)),b.quiz||b.active_element?b.loadLastSubmission(a(c)):(b.moodleNotifyFilterContentUpdated(),b.chapter.nextExercise())})},update:function(b){var c=this;b=b.filter(c.settings.exercise_selector).contents();var d=c.element.find(c.settings.content_selector).empty().append(b).hide();if(c.active_element){var e="";c.element.attr("data-title")&&(e="<p><b>"+c.element.attr("data-title")+"</b></p>"),c.element.find(c.settings.summary_selector).remove(),a(e).prependTo(c.element.find(c.settings.response_selector))}d.show();var f=c.element.css("height");if(c.active_element)if(c.settings.input)a("#"+c.chapterID+" textarea").css("height",f);else if("undefined"!=typeof a("#"+c.chapterID).data("scale")){var g=a(c.settings.ae_result_selector,c.element)[0].scrollHeight;a(c.settings.ae_result_selector,c.element).css({height:g+"px"})}else a(c.settings.ae_result_selector,c.element).css("height",f);this.element.height("auto"),this.bindNavEvents(),this.bindFormEvents(d)},bindNavEvents:function(){this.element.find(this.settings.navigation_selector).aplusModalLink(),this.element.find(this.settings.dropdown_selector).dropdown(),this.element.find(".page-modal").aplusModalLink()},bindFormEvents:function(a){if(!this.ajax){var b=a.find("form").attr("action",this.url),d=this;this.chapter.ajaxForms&&b.on("submit",function(a){a.preventDefault(),d.submit(this)})}c.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submitAjax:function(b,c,d,e){var f=this;a.ajax(b,{type:"POST",data:c,contentType:!1,processData:!1,dataType:"html"}).fail(function(g,h,i){if(e=e||0,200!==g.status&&5>e&&setTimeout(function(){f.submitAjax(b,c,d,e+1)},100),f.active_element){var j=a("<div>");j.attr("id","feedback"),j.append(f.chapter.messages.error),f.updateOutput(j)}else f.chapter.modalError(f.chapter.messages.error)}).done(function(g){e=e||0,a(g).find("div:contains('The submission could not be saved for some reason')").length>0&&5>e?(console.log("Submission not saved: trying submitAjax again in 100ms"),setTimeout(function(){console.log("Resubmit no.",e+1),f.submitAjax(b,c,d,e+1)},100)):d(g)})},generateFormData:function(b,c){b=a(b);var d=this.matchInputs(b),e=d[0],f=d[1],g=d[2],h=new FormData,i=this.chapterID,j=!0;return a.each(f,function(b,c){var d,e=a.find("#"+c);if(e[0].hasAttribute("data-inputs")){if(a(e).data("evaluating"))return j=!1,void(h=!1);d=a(e).find(".ae_result").text().trim()}else"file"===a(e).data("type")?d=a("#"+c+"_input_id").get(0).files[0]:c!==i?(d=a(e).data("value"),a("#"+c+"_input_id").val(d)):(d=a("#"+c+"_input_id").val(),a(e).data("value",d));d||(j=!1),h&&h.append(g[b],d)}),[e,j,h]},submit:function(b){var c=this,d=this.chapter;if(this.active_element){var e=this.chapterID,f=a.find('[data-inputs~="'+e+'"]');a.each(f,function(d,e){var f=c.generateFormData(e,b),g=f[0],h=f[1],i=f[2],j=g.chapterID,k=a("#"+j),l=k.find(g.settings.ae_result_selector);if(h||i){if(!h)return void a("#"+j).find(g.settings.ae_result_selector).html('<p style="color:red;">Fill out all the inputs</p>');k.data("evaluating",!0),"undefined"!=typeof k.data("scale")&&l.css({height:l.height()}),l.html("<p>Evaluating</p>");var m=g.url;g.submitAjax(m,i,function(b){var c=a(b);if(c.find(".alert-danger").length)c.find(".alert-danger").contents().text().indexOf("The grading queue is not configured.")>=0?(k.find(g.settings.ae_result_selector).html(c.find(".alert").text()),k.find(g.settings.ae_result_selector).append(c.find(".grading-task").text())):k.find(g.settings.ae_result_selector).html(c.find(".alert-danger").contents());else{var d=c.find(".exercise-wait").attr("data-poll-url");k.attr("data-poll-url",d),g.updateSubmission(c)}})}})}else{d.openModal(d.messages.submit);var g=this,h=a(b).attr("action"),i=new FormData(b);g.submitAjax(h,i,function(b){var c=a(b);if(g.quiz){var e=c.find(".badge").eq(2).clone();g.update(c),d.modalSuccess(g.element,e),g.moodleNotifyFilterContentUpdated()}else g.updateSubmission(c)})}},matchInputs:function(b){var c=b.attr("id"),d=this.chapter.aeOutputs[c],e=b.attr("data-inputs").split(" "),f=b.find(d.settings.ae_result_selector).attr("data-expected-inputs");return f?(f=f.trim().split(" "),f=a.grep(f,function(a){return""!==a||"\n"!==a})):f=[],[d,e,f]},updateSummary:function(a){this.element.find(this.settings.summary_selector).empty().append(a.find(this.settings.summary_selector).remove().contents()),this.bindNavEvents()},updateSubmission:function(b){if(this.active_element||(this.updateSummary(b),this.chapter.modalContent(b.filter(this.settings.exercise_selector).contents())),"function"==typeof a.aplusExerciseDetectWaits){var c,d=this;this.active_element&&(c="#"+this.chapterID),a.aplusExerciseDetectWaits(function(b){a.ajax(b).done(function(b){if(d.active_element)d.updateOutput(b),d.submit();else{var c=a(b),e=c.find(d.settings.submission_point_badges_selector),f=d.element.find(d.settings.summary_selector+" .badge");f.eq(0).replaceWith(e.eq(0).clone()),f.eq(2).replaceWith(e.eq(1).clone());var g=c.filter(d.settings.exercise_selector).contents();""==g.text().trim()?d.chapter.modalSuccess(d.element,e.eq(1).clone()):d.chapter.modalContent(g)}}).fail(function(){d.chapter.modalError(d.chapter.messages.error)})},c)}},updateOutput:function(b){var c=this,d=c.element.attr("data-type")||"text",e=a(b);e.is("#feedback")||(e=e.find("#feedback")),"text"==d?e=e.text():"image"==d&&(e='<img src="data:image/png;base64, '+e.text()+'" />');var f=c.element.find(c.settings.ae_result_selector);f.html(e),c.element.data("evaluating",!1),"undefined"!=typeof c.element.data("scale")&&f.css({height:"auto"})},updateInputs:function(b){b=b.submission_data;var c=this,d=c.matchInputs(c.element),e=(d[0],d[1]),f=d[2];a(b).each(function(b,c){var d=c[0],g=e[a.inArray(d,f)],h=c[1];"file"!==a("#"+g).data("type")&&(a(a.find("#"+g)).data("value",h),a("#"+g+"_input_id").val(h))})},loadLastSubmission:function(b){var c=b.find(this.settings.last_submission_selector),d=this;if(c.length>0){var e=c.attr("href");if(e&&"#"!==e){var f="html";if(d.active_element){var g=e.match(/submission\.php\?id=(\d+)$/);g?(e="submission_data.php?id="+g[1],f="json"):console.error("Can not read the submission data URL")}this.showLoader("load"),a.ajax(e,{dataType:f}).fail(function(){d.showLoader("error")}).done(function(b){if(d.hideLoader(),d.active_element)d.updateOutput(b.feedback),d.updateInputs(b);else{var c=d.element.find(d.settings.response_selector).empty().append(a(b).filter(d.settings.exercise_selector).contents());d.bindFormEvents(c)}d.moodleNotifyFilterContentUpdated(),d.chapter.nextExercise()})}else this.moodleNotifyFilterContentUpdated(),this.chapter.nextExercise()}else this.chapter.nextExercise()},showLoader:function(a){this.loader.show().find(this.settings.message_selector).text(this.chapter.messages[a]),"error"==a?this.loader.removeClass("progress-bar-animated").addClass("bg-danger"):this.loader.addClass("progress-bar-animated").removeClass("bg-danger")},hideLoader:function(){this.loader.hide()},moodleNotifyFilterContentUpdated:function(){b.notifyFilterContentUpdated("#"+this.element.attr("id"))}}),a.fn[g]=function(b,c){return this.each(function(){a.data(this,"plugin_"+g)||a.data(this,"plugin_"+g,new f(this,b,c))})},a.fn[h]=function(){return this.each(function(){var b=a.data(this,"plugin_"+g);b&&b.load()})}}(a,b,window,document),{}});