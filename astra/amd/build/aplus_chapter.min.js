define(["jquery","core/event","mod_astra/aplus_poll","theme_boost/dropdown","mod_astra/aplus_modal"],function(e,t){var s;return function(){if("function"==typeof window.CustomEvent)return;function e(e,t){var s=void 0!==t.bubbles&&t.bubbles,i=void 0!==t.cancelable&&t.cancelable,a=void 0!==t.detail?t.detail:void 0,n=document.createEvent("CustomEvent");return n.initCustomEvent(e,s,i,a),n}e.prototype=window.Event.prototype,window.CustomEvent=e}(),function(s,e,i,t,a){"use strict";var n="aplusChapter",r={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",active_element_attr:"data-aplus-active-element",loading_selector:"#loading-indicator",quiz_success_selector:"#quiz-success",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},modal_selector:"#page-modal"};function l(e,t){this.dom_element=e,this.element=s(e),this.settings=s.extend({},r,t),this.ajaxForms=!1,this.url=null,this.modalElement=null,this.loader=null,this.messages=null,this.quizSuccess=null,this.aeOutputs={},this.init()}s.extend(l.prototype,{init:function(){this.ajaxForms=!!i.FormData,this.url=this.element.attr(this.settings.chapter_url_attr),this.modalElement=s(this.settings.modal_selector),this.loader=s(this.settings.loading_selector),this.messages=this.readMessages(),this.quizSuccess=s(this.settings.quiz_success_selector),this.element.find("["+this.settings.active_element_attr+"='in']").aplusExercise(this,{input:!0});var e=this.element.find("["+this.settings.exercise_url_attr+"]");if(0<e.length)this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-loaded",{bubbles:!0})),e.aplusExercise(this),this.exercises=e,this.exercisesIndex=0,this.exercisesSize=e.length,this.nextExercise();else{var t="text/x.aplus-exercise";this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:t}})),this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:t}}))}},nextExercise:function(){this.exercisesIndex<this.exercisesSize&&(this.exercises.eq(this.exercisesIndex).aplusExerciseLoad(),this.exercisesIndex++),this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-ready",{bubbles:!0}))},readMessages:function(){var e={};for(var t in this.settings.message_attr)e[t]=this.loader.attr(this.settings.message_attr[t]);return e},cloneLoader:function(e){return s(this.settings.loading_selector).clone().removeAttr("id").show()},openModal:function(e){this.modalElement.aplusModal("open",e)},modalError:function(e){this.modalElement.aplusModal("error",e)},modalContent:function(e){this.modalElement.aplusModal("content",{content:e}),this.renderMath()},modalSuccess:function(e,t){var s=this.quizSuccess.clone().attr("class",e.attr("class")).removeClass("exercise").removeAttr("id").show();s.find(".badge-placeholder").empty().append(t),t.hasClass("badge-success")||t.hasClass("badge-warning")?s.find(".btn-success").css("display","block"):s.find(".btn-success").hide(),this.modalContent(s)},renderMath:function(){e.notifyFilterContentUpdated(this.settings.modal_selector)}}),s.fn[n]=function(e){return this.each(function(){s.data(this,"plugin_"+n)||s.data(this,"plugin_"+n,new l(this,e))})}}(e,t,window,document),function(p,e,i,t,s){"use strict";var n="aplusExercise",a={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",content_element:'<div class="exercise-content"></div>',content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:'ul.exercise-nav a[class!="dropdown-toggle"]',dropdown_selector:"ul.exercise-nav .dropdown-toggle",last_submission_selector:"ul.exercise-nav .dropdown-menu a:first-child",active_element_attr:"data-aplus-active-element",ae_result_selector:".ae_result",input:!1,submission_point_badges_selector:"[data-points-badge] .badge"};function r(e,t,s){this.dom_element=e,this.element=p(e),this.chapter=t,this.settings=p.extend({},a,s),this.url=null,this.quiz=!1,this.ajax=!1,this.active_element=!1,this.loader=null,this.messages={},this.init()}p.extend(r.prototype,{init:function(){if(this.chapterID=this.element.attr("id"),this.url=this.element.attr(this.chapter.settings.exercise_url_attr),this.quiz=this.element.attr(this.settings.quiz_attr)!==s,this.ajax=this.element.attr(this.settings.ajax_attr)!==s,this.active_element=this.element.attr(this.settings.active_element_attr)!==s,this.exercise_type=this.quiz?"text/x.aplus-exercise.quiz.v1":this.ajax?"text/x.aplus-exercise.iframe.v1":this.active_element?"text/x.aplus-exercise.active-element.v1":"text/x.aplus-exercise",this.active_element&&!this.settings.input&&(this.chapter.aeOutputs[this.chapterID]=this),this.loader=this.chapter.cloneLoader(),this.element.height(this.element.height()).empty(),this.element.append(this.settings.content_element),this.element.append(this.loader),this.settings.input&&this.load(),!this.active_element&&this.ajax){var t=this;i.addEventListener("message",function(e){"a-plus-refresh-stats"===e.data.type&&p.ajax(t.url,{dataType:"html"}).done(function(e){t.updateSummary(p(e))})})}},makeInputForm:function(e,t,s,i){var a=p("<div>");a.attr("id","exercise-all");var n=p("<form>");n.attr("action",""),n.attr("method","post");var r=p("<div>");r.attr("class","form-group");var l,o=p("<label>");if(o.attr("class","control-label"),o.attr("for",e+"_input"),o.html(t),s&&"clickable"!==s){if("file"===s)(l=p("<input>")).attr("type","file"),n.attr("enctype","multipart/form-data");else if("dropdown"==s.substring(0,8)){l=p("<select>");var d=s.split(":").pop().split(",");p.each(d,function(e,t){var s=p("<option>");s.text(t),s.val(t),l.append(s)})}}else(l=p("<textarea>")).val(i);l.attr("class","form-control"),l.attr("id",e+"_input_id"),l.attr("name",e+"_input");var u=p("<div>");r.attr("class","form-group");var c=p("<input>");return c.attr("class","btn btn-primary"),c.attr("value","Submit"),c.attr("type","submit"),p(r).append(o,l),p(u).append(c),p(n).append(r,u),p(a).append(n),p(a)},load:function(t){this.showLoader("load");var s=this;if(s.settings.input){var e=s.element.data("title"),i=s.element.data("type"),a=s.element.data("default");e||(e=""),a||(a=""),s.hideLoader();var n=s.makeInputForm(s.chapterID,e,i,a);s.update(n),s.loadLastSubmission(n),t||s.chapter.nextExercise()}else p.ajax(this.url,{dataType:"html"}).fail(function(){s.showLoader("error"),t||s.chapter.nextExercise()}).done(function(e){s.hideLoader(),s.update(p(e)),s.quiz||s.active_element?s.loadLastSubmission(p(e)):(s.renderMath(),t||s.chapter.nextExercise())})},update:function(e){var t=this;e=e.filter(t.settings.exercise_selector).contents();var s=t.element.find(t.settings.content_selector).empty().append(e).hide();if(this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:this.exercise_type}})),t.active_element){var i="";t.element.attr("data-title")&&(i="<p><b>"+t.element.attr("data-title")+"</b></p>"),t.element.find(t.settings.summary_selector).remove(),p(i).prependTo(t.element.find(t.settings.response_selector))}s.show();var a=t.element.css("height");if(t.active_element)if(t.settings.input)p("#"+t.chapterID+" textarea").css("height",a);else if(void 0!==p("#"+t.chapterID).data("scale")){var n=p(t.settings.ae_result_selector,t.element)[0].scrollHeight;p(t.settings.ae_result_selector,t.element).css({height:n+"px"})}else p(t.settings.ae_result_selector,t.element).css("height",a);this.element.height("auto"),this.bindNavEvents(),this.bindFormEvents(s),this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:this.exercise_type}}))},bindNavEvents:function(){this.element.find(this.settings.navigation_selector).aplusModalLink(),this.element.find(this.settings.dropdown_selector).dropdown(),this.element.find(".page-modal").aplusModalLink()},bindFormEvents:function(e){if(!this.ajax){var t=e.find("form").attr("action",this.url),s=this;this.chapter.ajaxForms&&t.on("submit",function(e){e.preventDefault(),s.submit(this)})}i.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submitAjax:function(a,n,r,l){var o=this;p.ajax(a,{type:"POST",data:n,contentType:!1,processData:!1,dataType:"html"}).fail(function(e,t,s){if(l=l||0,200!==e.status&&l<5&&setTimeout(function(){o.submitAjax(a,n,r,l+1)},100),o.active_element){var i=p("<div>");i.attr("id","feedback"),i.append(o.chapter.messages.error),o.updateOutput(i)}else o.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:o.exercise_type}})),o.chapter.modalError(o.chapter.messages.error)}).done(function(e){r(e)})},collectFormData:function(e,t){e=p(e);var s=this.matchInputs(e),i=s[0],a=s[1],n=s[2],r=new FormData,l=this.chapterID,o=!0;return p.each(a,function(e,t){var s,i=p.find("#"+t),a=p("#"+t+"_input_id");if(i[0].hasAttribute("data-inputs")){if(p(i).data("evaluating"))return void(r=o=!1);s=p(i).find(".ae_result").text().trim()}else"file"===p(i).data("type")?s=a.get(0).files[0]:t!==l?(s=a.val(),p(i).data("value")&&(s=p(i).data("value")),a.val(s)):(s=a.val(),p(i).data("value",s));s||(o=!1),r&&r.append(n[e],s)}),[i,o,r]},submit:function(u){var c=this,i=this.chapter;if(this.active_element){var e=this.chapterID,t=p.find('[data-inputs~="'+e+'"]');p.each(t,function(e,t){var s=c.collectFormData(t,u),n=s[0],i=s[1],a=s[2],r=n.chapterID,l=p("#"+r),o=l.find(n.settings.ae_result_selector);if(i||a){if(!i)return p("#"+r).find(n.settings.ae_result_selector).html('<p style="color:red;">Fill out all the inputs</p>'),void c.dom_element.dispatchEvent(new CustomEvent("aplus:submission-aborted",{bubbles:!0,detail:{type:c.exercise_type}}));l.data("evaluating",!0),void 0!==l.data("scale")&&o.css({height:o.height()}),o.html("<p>Evaluating</p>");var d=n.url;n.submitAjax(d,a,function(e){var t=p(e);if(t.find(".alert-danger").length)0<=t.find(".alert-danger").contents().text().indexOf("The grading queue is not configured.")?(l.find(n.settings.ae_result_selector).html(t.find(".alert").text()),l.find(n.settings.ae_result_selector).append(t.find(".grading-task").text())):l.find(n.settings.ae_result_selector).html(t.find(".alert-danger").contents());else{var s=t.find(".exercise-wait"),i=s.attr("data-poll-url"),a=s.attr("data-ready-url");l.attr("data-poll-url",i),l.attr("data-ready-url",a),n.updateSubmission(t)}})}})}else{i.openModal(i.messages.submit);var a=this,s=p(u).attr("action"),n=new FormData(u);a.submitAjax(s,n,function(e){var t=p(e);if(a.quiz){var s=t.find(".badge").eq(2).clone();a.update(t),i.modalSuccess(a.element,s),a.renderMath(),a.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:a.exercise_type}}))}else a.updateSubmission(t)})}},matchInputs:function(e){var t=e.attr("id"),s=this.chapter.aeOutputs[t],i=e.attr("data-inputs").split(" "),a=e.find(s.settings.ae_result_selector).attr("data-expected-inputs");return[s,i,a=a?(a=a.trim().split(" "),p.grep(a,function(e){return""!==e||"\n"!==e})):[]]},updateSummary:function(e){this.element.find(this.settings.summary_selector).empty().append(e.find(this.settings.summary_selector).remove().contents()),this.bindNavEvents()},updateSubmission:function(e){if(this.active_element||(this.updateSummary(e),this.chapter.modalContent(e.filter(this.settings.exercise_selector).contents())),"function"==typeof p.aplusExerciseDetectWaits){var t,n=this;this.active_element&&(t="#"+this.chapterID),p.aplusExerciseDetectWaits(function(e,t){t?n.active_element?n.dispatchEventToActiveElem("aplus:exercise-submission-failure"):(n.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:n.exercise_type}})),n.load(!0)):p.ajax(e).done(function(e){if(n.active_element)n.updateOutput(e),n.dispatchEventToActiveElem("aplus:submission-finished"),n.submit();else{var t=p(e),s=t.find(n.settings.submission_point_badges_selector),i=n.element.find(n.settings.summary_selector+" .badge");i.eq(0).replaceWith(s.eq(0).clone()),i.eq(2).replaceWith(s.eq(1).clone());var a=t.filter(n.settings.exercise_selector).contents();""==a.text().trim()?n.chapter.modalSuccess(n.element,s.eq(1).clone()):n.chapter.modalContent(a),n.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:n.exercise_type}})),n.load(!0)}}).fail(function(){n.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:n.exercise_type}})),n.chapter.modalError(n.chapter.messages.error),n.load(!0)})},t)}},updateOutput:function(e){var t=this,s=t.element.attr("data-type")||"text",i=p(e);i.is("#feedback")||(i=i.find("#feedback")),"text"==s?i=i.text():"image"==s&&(i='<img src="data:image/png;base64, '+i.text()+'" />');var a=t.element.find(t.settings.ae_result_selector);a.html(i),t.element.data("evaluating",!1),void 0!==t.element.data("scale")&&a.css({height:"auto"})},updateInputs:function(e){e=e.submission_data;var t=this.matchInputs(this.element),s=(t[0],t[1]),i=t[2];for(var a in e)if(e.hasOwnProperty(a)){var n=a,r=s[p.inArray(n,i)],l=e[a];"file"!==p("#"+r).data("type")&&(p(p.find("#"+r)).data("value",l),p("#"+r+"_input_id").val(l).trigger("change"))}},dispatchEventToActiveElem:function(e){this.dom_element.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{type:this.exercise_type}}));for(var t=this.matchInputs(this.element)[1],s=0;s<t.length;++s){var i=t[s],a=p("#"+i).data("plugin_"+n);a&&a.dom_element.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{type:a.exercise_type}}))}},loadLastSubmission:function(e){var t=e.find(this.settings.last_submission_selector),s=this;if(0<t.length){var i=t.attr("href");if(i&&"#"!==i){var a="html";if(s.active_element){var n=i.match(/submission\.php\?id=(\d+)$/);n?(i="submission_data.php?id="+n[1],a="json"):console.error("Can not read the submission data URL")}this.showLoader("load"),p.ajax(i,{dataType:a}).fail(function(){s.showLoader("error")}).done(function(e){if(s.hideLoader(),s.active_element)s.updateOutput(e.feedback),s.updateInputs(e);else{s.element.find(s.settings.response_selector).empty().append(p(e).filter(s.settings.exercise_selector).contents());s.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:s.exercise_type}})),s.bindFormEvents(s.element),s.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:s.exercise_type}}))}s.renderMath()})}else s.renderMath()}s.chapter.nextExercise()},showLoader:function(e){this.loader.show().find(this.settings.message_selector).text(this.chapter.messages[e]),"error"==e?this.loader.removeClass("progress-bar-animated").addClass("bg-danger"):this.loader.addClass("progress-bar-animated").removeClass("bg-danger")},hideLoader:function(){this.loader.hide()},renderMath:function(){e.notifyFilterContentUpdated("#"+this.element.attr("id"))}}),p.fn[n]=function(e,t){return this.each(function(){p.data(this,"plugin_"+n)||p.data(this,"plugin_"+n,new r(this,e,t))})},p.fn.aplusExerciseLoad=function(){return this.each(function(){var e=p.data(this,"plugin_"+n);e&&e.load()})}}(e,t,window,document),(s=e)(document).on("aplus:exercise-loaded",function(e){s(e.target).find("form").each(function(){var e=s(this);"post"==e.prop("method")&&e.on("submit",function(e){s(this).find('[type="submit"]').prop("disabled",!0).attr("data-aplus-submit-disabled","yes")})})}),s(document).on("aplus:exercise-submission-failure aplus:submission-finished aplus:submission-aborted",function(e){s(e.target).find("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")}),s(document).on("hidden.bs.modal",function(e){s("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")}),{}});