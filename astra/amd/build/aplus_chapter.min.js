/**
 * A+ chapter learning object with embedded exercises as an AMD module for Moodle.
 * The exercises are downloaded asynchronously (AJAX) and inserted in the DOM.
 * 
 * In an HTML page, run the following JS code once to activate it:
 * // Construct the page chapter element.
 * $("#exercise").aplusChapter();
 * 
 * Source: A+ (a-plus/exercise/static/exercise/chapter.js)
 * License: GNU GPL v3
 * 
 * @module mod_astra/aplus_chapter
 */
define(["jquery","mod_astra/twbootstrap"],function(a){return function(a,b,c,d){function e(b,c){this.element=a(b),this.settings=a.extend({},g,c),this.ajaxForms=!1,this.url=null,this.modalElement=null,this.init()}var f="aplusChapter",g={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",loading_selector:"#loading-indicator",modal_selector:"#embed-modal",modal_content_selector:".modal-body"};a.extend(e.prototype,{init:function(){this.ajaxForms=!!b.FormData,this.url=this.element.attr(this.settings.chapter_url_attr),this.modalElement=a(this.settings.modal_selector).modal({show:!1}),this.element.find("["+this.settings.exercise_url_attr+"]").each(function(b){a(this).attr("id","chapter-exercise-"+(b+1))}).aplusExercise(this)},cloneLoader:function(b){return a(this.settings.loading_selector).clone().removeAttr("id").removeClass("hide")},openModalURL:function(b){if(b&&"#"!==b){var c=this;a.ajax(b).done(function(b){c.openModal(a(b).filter("table,#exercise"))}).fail(function(){c.openModal("Internal error.")})}},openModal:function(a){this.modalElement.find(this.settings.modal_content_selector).empty().append(a).find(".file-modal").aplusFileModal(),this.modalElement.modal("show")}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(a,window,document),function(a,b,c,d){function e(b,c,d){this.element=a(b),this.chapter=c,this.settings=a.extend({},h,d),this.url=null,this.quiz=!1,this.ajax=!1,this.loader=null,this.init()}var f="aplusExercise",g="aplusReload",h={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},content_element:'<div class="exercise-content"></div>',content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:'ul.nav a[class!="dropdown-toggle"]',dropdown_selector:"ul.nav .dropdown-toggle",last_submission_selector:"ul.nav ul.dropdown-menu li:first-child a"};a.extend(e.prototype,{init:function(){if(this.chapterID=this.element.attr("id"),this.url=this.element.attr(this.chapter.settings.exercise_url_attr),this.url=this.url,this.quiz=this.element.attr(this.settings.quiz_attr)!==d,this.ajax=this.element.attr(this.settings.ajax_attr)!==d,this.loader=this.chapter.cloneLoader(),this.element.append(this.settings.content_element),this.element.append(this.loader),this.load(),this.ajax){var c=this;b.addEventListener("message",function(b){"a-plus-refresh-stats"===b.data.type&&a.ajax(c.url,{dataType:"html"}).done(function(b){c.updateSummary(a(b))})})}},load:function(){this.showLoader("load");var b=this;a.ajax(this.url,{dataType:"html"}).fail(function(){b.showLoader("error")}).done(function(c){b.hideLoader(),b.update(a(c)),b.quiz&&b.loadLastSubmission(a(c))})},update:function(a){var b=this.element.find(this.settings.content_selector).empty().append(a.filter(this.settings.exercise_selector).contents());this.bindNavEvents(),this.bindFormEvents(b)},bindNavEvents:function(){var b=this.chapter;this.element.find(this.settings.navigation_selector).on("click",function(c){a(this).hasClass("no-open-modal")||(c.preventDefault(),b.openModalURL(a(this).attr("href")))}),this.element.find(this.settings.dropdown_selector).dropdown()},bindFormEvents:function(a){if(!this.ajax){var c=a.find("form").attr("action",this.url),d=this;this.chapter.ajaxForms&&c.on("submit",function(a){a.preventDefault(),d.submit(this)})}b.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submit:function(b){this.showLoader("submit");var c=this;a.ajax(a(b).attr("action"),{type:"POST",data:new FormData(b),contentType:!1,processData:!1,dataType:"html"}).fail(function(){c.showLoader("error"),a(b).find(":input").prop("disabled",!1)}).done(function(d){c.hideLoader(),c.quiz?c.update(a(d)):c.updateSubmission(a(d)),a(b).find(":input").prop("disabled",!1)}),a(b).find(":input").prop("disabled",!0)},updateSummary:function(a){this.element.find(this.settings.summary_selector).empty().append(a.find(this.settings.summary_selector).contents()),this.bindNavEvents()},updateSubmission:function(b){if(this.updateSummary(b),this.chapter.openModal(b.find(this.settings.response_selector).contents()),"function"==typeof a.aplusExerciseDetectWaits){var c=this;a.aplusExerciseDetectWaits(function(a){c.chapter.openModalURL(a)})}},loadLastSubmission:function(b){var c=b.find(this.settings.last_submission_selector);if(c.size()>0){var d=c.attr("href");if(d&&"#"!==d){this.showLoader("load");var e=this;a.ajax(c.attr("href"),{dataType:"html"}).fail(function(){e.showLoader("error")}).done(function(a){e.hideLoader();var b=e.element.find(e.settings.response_selector).empty().append(a);b.find("table.submission-info").remove(),e.bindFormEvents(b)})}}},showLoader:function(a){this.loader.show().find(this.settings.message_selector).text(this.loader.attr(this.settings.message_attr[a])),"error"==a?this.loader.removeClass("active").addClass("progress-bar-danger"):this.loader.addClass("active").removeClass("progress-bar-danger")},hideLoader:function(){this.loader.hide()}}),a.fn[f]=function(b,c){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b,c))})},a.fn[g]=function(){return this.each(function(){var b=a.data(this,"plugin_"+f);b&&b.load()})}}(a,window,document),{}});