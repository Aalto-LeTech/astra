define(["jquery","core/event","mod_astra/aplus_poll","theme_boost/dropdown","mod_astra/aplus_modal"],function(e,t){return function(e,t,s,a,i){var n="aplusChapter",r={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",active_element_attr:"data-aplus-active-element",loading_selector:"#loading-indicator",quiz_success_selector:"#quiz-success",message_selector:".progress-bar",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},modal_selector:"#page-modal"};function o(t,s){this.element=e(t),this.settings=e.extend({},r,s),this.ajaxForms=!1,this.url=null,this.modalElement=null,this.loader=null,this.messages=null,this.quizSuccess=null,this.aeOutputs={},this.init()}e.extend(o.prototype,{init:function(){this.ajaxForms=!!s.FormData,this.url=this.element.attr(this.settings.chapter_url_attr),this.modalElement=e(this.settings.modal_selector),this.loader=e(this.settings.loading_selector),this.messages=this.readMessages(),this.quizSuccess=e(this.settings.quiz_success_selector),this.element.find("["+this.settings.active_element_attr+"='in']").aplusExercise(this,{input:!0}),this.exercises=this.element.find("["+this.settings.exercise_url_attr+"]").aplusExercise(this),this.exercisesIndex=0,this.exercisesSize=this.exercises.length,this.exercisesSize>0&&this.nextExercise()},nextExercise:function(){this.exercisesIndex<this.exercisesSize&&(this.exercises.eq(this.exercisesIndex).aplusExerciseLoad(),this.exercisesIndex++)},readMessages:function(){var e={};for(var t in this.settings.message_attr)e[t]=this.loader.attr(this.settings.message_attr[t]);return e},cloneLoader:function(t){return e(this.settings.loading_selector).clone().removeAttr("id").show()},openModal:function(e){this.modalElement.aplusModal("open",e)},modalError:function(e){this.modalElement.aplusModal("error",e)},modalContent:function(e){this.modalElement.aplusModal("content",{content:e}),this.moodleNotifyFilterContentUpdatedInModal()},modalSuccess:function(t,s){this.modalElement.one("hidden.bs.modal",function(s){e(a.body).animate({scrollTop:t.offset().top},300)});var i=this.quizSuccess.clone().attr("class",t.attr("class")).removeClass("exercise").removeAttr("id").show();i.find(".badge-placeholder").empty().append(s),s.hasClass("badge-success")||s.hasClass("badge-warning")?i.find(".btn-success").css("display","block"):i.find(".btn-success").hide(),this.modalContent(i)},moodleNotifyFilterContentUpdatedInModal:function(){t.notifyFilterContentUpdated(this.settings.modal_selector)}}),e.fn[n]=function(t){return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new o(this,t))})}}(e,t,window,document),function(e,t,s,a,i){var n="aplusExercise",r={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",content_element:'<div class="exercise-content"></div>',content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:'ul.exercise-nav a[class!="dropdown-toggle"]',dropdown_selector:"ul.exercise-nav .dropdown-toggle",last_submission_selector:"ul.exercise-nav .dropdown-menu a:first-child",active_element_attr:"data-aplus-active-element",ae_result_selector:".ae_result",input:!1,submission_point_badges_selector:"[data-points-badge] .badge"};function o(t,s,a){this.element=e(t),this.chapter=s,this.settings=e.extend({},r,a),this.url=null,this.quiz=!1,this.ajax=!1,this.active_element=!1,this.loader=null,this.messages={},this.init()}e.extend(o.prototype,{init:function(){if(this.chapterID=this.element.attr("id"),this.url=this.element.attr(this.chapter.settings.exercise_url_attr),this.quiz=this.element.attr(this.settings.quiz_attr)!==i,this.ajax=this.element.attr(this.settings.ajax_attr)!==i,this.active_element=this.element.attr(this.settings.active_element_attr)!==i,this.active_element&&!this.settings.input&&(this.chapter.aeOutputs[this.chapterID]=this),this.loader=this.chapter.cloneLoader(),this.element.height(this.element.height()).empty(),this.element.append(this.settings.content_element),this.element.append(this.loader),this.settings.input&&this.load(),!this.active_element&&this.ajax){var t=this;s.addEventListener("message",function(s){"a-plus-refresh-stats"===s.data.type&&e.ajax(t.url,{dataType:"html"}).done(function(s){t.updateSummary(e(s))})})}},makeInputForm:function(t,s,a,i){var n=e("<div>");n.attr("id","exercise-all");var r=e("<form>");r.attr("action",""),r.attr("method","post");var o=e("<div>");o.attr("class","form-group");var l,d=e("<label>");if(d.attr("class","control-label"),d.attr("for",t+"_input"),d.html(s),a){if("file"===a)(l=e("<input>")).attr("type","file"),r.attr("enctype","multipart/form-data");else if("dropdown"==a.substring(0,8)){l=e("<select>");var c=a.split(":").pop().split(",");e.each(c,function(t,s){var a=e("<option>");a.text(s),a.val(s),l.append(a)})}}else(l=e("<textarea>")).val(i);l.attr("class","form-control"),l.attr("id",t+"_input_id"),l.attr("name",t+"_input");var u=e("<div>");o.attr("class","form-group");var h=e("<input>");return h.attr("class","btn btn-primary"),h.attr("value","Submit"),h.attr("type","submit"),e(o).append(d,l),e(u).append(h),e(r).append(o,u),e(n).append(r),e(n)},load:function(){this.showLoader("load");var t=this;if(t.settings.input){var s=t.element.data("title"),a=t.element.data("type"),i=t.element.data("default");s||(s=""),i||(i=""),t.hideLoader();var n=t.makeInputForm(t.chapterID,s,a,i);t.update(n),t.loadLastSubmission(n),t.chapter.nextExercise()}else e.ajax(this.url,{dataType:"html"}).fail(function(){t.showLoader("error"),t.chapter.nextExercise()}).done(function(s){t.hideLoader(),t.update(e(s)),t.quiz||t.active_element?t.loadLastSubmission(e(s)):(t.moodleNotifyFilterContentUpdated(),t.chapter.nextExercise())})},update:function(t){var s=this;t=t.filter(s.settings.exercise_selector).contents();var a=s.element.find(s.settings.content_selector).empty().append(t).hide();if(s.active_element){var i="";s.element.attr("data-title")&&(i="<p><b>"+s.element.attr("data-title")+"</b></p>"),s.element.find(s.settings.summary_selector).remove(),e(i).prependTo(s.element.find(s.settings.response_selector))}a.show();var n=s.element.css("height");if(s.active_element)if(s.settings.input)e("#"+s.chapterID+" textarea").css("height",n);else if(void 0!==e("#"+s.chapterID).data("scale")){var r=e(s.settings.ae_result_selector,s.element)[0].scrollHeight;e(s.settings.ae_result_selector,s.element).css({height:r+"px"})}else e(s.settings.ae_result_selector,s.element).css("height",n);this.element.height("auto"),this.bindNavEvents(),this.bindFormEvents(a)},bindNavEvents:function(){this.element.find(this.settings.navigation_selector).aplusModalLink(),this.element.find(this.settings.dropdown_selector).dropdown(),this.element.find(".page-modal").aplusModalLink()},bindFormEvents:function(e){if(!this.ajax){var t=e.find("form").attr("action",this.url),a=this;this.chapter.ajaxForms&&t.on("submit",function(e){e.preventDefault(),a.submit(this)})}s.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submitAjax:function(t,s,a,i){var n=this;e.ajax(t,{type:"POST",data:s,contentType:!1,processData:!1,dataType:"html"}).fail(function(r,o,l){if(i=i||0,200!==r.status&&i<5&&setTimeout(function(){n.submitAjax(t,s,a,i+1)},100),n.active_element){var d=e("<div>");d.attr("id","feedback"),d.append(n.chapter.messages.error),n.updateOutput(d)}else n.chapter.modalError(n.chapter.messages.error)}).done(function(r){i=i||0,e(r).find("div:contains('The submission could not be saved for some reason')").length>0&&i<5?(console.log("Submission not saved: trying submitAjax again in 100ms"),setTimeout(function(){console.log("Resubmit no.",i+1),n.submitAjax(t,s,a,i+1)},100)):a(r)})},generateFormData:function(t,s){t=e(t);var a=this.matchInputs(t),i=a[0],n=a[1],r=a[2],o=new FormData,l=this.chapterID,d=!0;return e.each(n,function(t,s){var a,i=e.find("#"+s);if(i[0].hasAttribute("data-inputs")){if(e(i).data("evaluating"))return d=!1,void(o=!1);a=e(i).find(".ae_result").text().trim()}else"file"===e(i).data("type")?a=e("#"+s+"_input_id").get(0).files[0]:s!==l?(a=e(i).data("value"),e("#"+s+"_input_id").val(a)):(a=e("#"+s+"_input_id").val(),e(i).data("value",a));a||(d=!1),o&&o.append(r[t],a)}),[i,d,o]},submit:function(t){var s=this,a=this.chapter;if(this.active_element){var i=this.chapterID,n=e.find('[data-inputs~="'+i+'"]');e.each(n,function(a,i){var n=s.generateFormData(i,t),r=n[0],o=n[1],l=n[2],d=r.chapterID,c=e("#"+d),u=c.find(r.settings.ae_result_selector);if(o||l)if(o){c.data("evaluating",!0),void 0!==c.data("scale")&&u.css({height:u.height()}),u.html("<p>Evaluating</p>");var h=r.url;r.submitAjax(h,l,function(t){var s=e(t);if(s.find(".alert-danger").length)s.find(".alert-danger").contents().text().indexOf("The grading queue is not configured.")>=0?(c.find(r.settings.ae_result_selector).html(s.find(".alert").text()),c.find(r.settings.ae_result_selector).append(s.find(".grading-task").text())):c.find(r.settings.ae_result_selector).html(s.find(".alert-danger").contents());else{var a=s.find(".exercise-wait"),i=a.attr("data-poll-url"),n=a.attr("data-ready-url");c.attr("data-poll-url",i),c.attr("data-ready-url",n),r.updateSubmission(s)}})}else e("#"+d).find(r.settings.ae_result_selector).html('<p style="color:red;">Fill out all the inputs</p>')})}else{a.openModal(a.messages.submit);var r=this,o=e(t).attr("action"),l=new FormData(t);r.submitAjax(o,l,function(t){var s=e(t);if(r.quiz){var i=s.find(".badge").eq(2).clone();r.update(s),a.modalSuccess(r.element,i),r.moodleNotifyFilterContentUpdated()}else r.updateSubmission(s)})}},matchInputs:function(t){var s=t.attr("id"),a=this.chapter.aeOutputs[s],i=t.attr("data-inputs").split(" "),n=t.find(a.settings.ae_result_selector).attr("data-expected-inputs");return n?(n=n.trim().split(" "),n=e.grep(n,function(e){return""!==e||"\n"!==e})):n=[],[a,i,n]},updateSummary:function(e){this.element.find(this.settings.summary_selector).empty().append(e.find(this.settings.summary_selector).remove().contents()),this.bindNavEvents()},updateSubmission:function(t){if(this.active_element||(this.updateSummary(t),this.chapter.modalContent(t.filter(this.settings.exercise_selector).contents())),"function"==typeof e.aplusExerciseDetectWaits){var s,a=this;this.active_element&&(s="#"+this.chapterID),e.aplusExerciseDetectWaits(function(t){e.ajax(t).done(function(t){if(a.active_element)a.updateOutput(t),a.submit();else{var s=e(t),i=s.find(a.settings.submission_point_badges_selector),n=a.element.find(a.settings.summary_selector+" .badge");n.eq(0).replaceWith(i.eq(0).clone()),n.eq(2).replaceWith(i.eq(1).clone());var r=s.filter(a.settings.exercise_selector).contents();""==r.text().trim()?a.chapter.modalSuccess(a.element,i.eq(1).clone()):a.chapter.modalContent(r)}}).fail(function(){a.chapter.modalError(a.chapter.messages.error)})},s)}},updateOutput:function(t){var s=this,a=s.element.attr("data-type")||"text",i=e(t);i.is("#feedback")||(i=i.find("#feedback")),"text"==a?i=i.text():"image"==a&&(i='<img src="data:image/png;base64, '+i.text()+'" />');var n=s.element.find(s.settings.ae_result_selector);n.html(i),s.element.data("evaluating",!1),void 0!==s.element.data("scale")&&n.css({height:"auto"})},updateInputs:function(t){t=t.submission_data;var s=this.matchInputs(this.element),a=(s[0],s[1]),i=s[2];for(var n in t)if(t.hasOwnProperty(n)){var r=n,o=a[e.inArray(r,i)],l=t[n];"file"!==e("#"+o).data("type")&&(e(e.find("#"+o)).data("value",l),e("#"+o+"_input_id").val(l))}},loadLastSubmission:function(t){var s=t.find(this.settings.last_submission_selector),a=this;if(s.length>0){var i=s.attr("href");if(i&&"#"!==i){var n="html";if(a.active_element){var r=i.match(/submission\.php\?id=(\d+)$/);r?(i="submission_data.php?id="+r[1],n="json"):console.error("Can not read the submission data URL")}this.showLoader("load"),e.ajax(i,{dataType:n}).fail(function(){a.showLoader("error")}).done(function(t){if(a.hideLoader(),a.active_element)a.updateOutput(t.feedback),a.updateInputs(t);else{var s=a.element.find(a.settings.response_selector).empty().append(e(t).filter(a.settings.exercise_selector).contents());a.bindFormEvents(s)}a.moodleNotifyFilterContentUpdated(),a.chapter.nextExercise()})}else this.moodleNotifyFilterContentUpdated(),this.chapter.nextExercise()}else this.chapter.nextExercise()},showLoader:function(e){this.loader.show().find(this.settings.message_selector).text(this.chapter.messages[e]),"error"==e?this.loader.removeClass("progress-bar-animated").addClass("bg-danger"):this.loader.addClass("progress-bar-animated").removeClass("bg-danger")},hideLoader:function(){this.loader.hide()},moodleNotifyFilterContentUpdated:function(){t.notifyFilterContentUpdated("#"+this.element.attr("id"))}}),e.fn[n]=function(t,s){return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new o(this,t,s))})},e.fn.aplusExerciseLoad=function(){return this.each(function(){var t=e.data(this,"plugin_"+n);t&&t.load()})}}(e,t,window,document),{}});