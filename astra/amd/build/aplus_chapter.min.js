define(["jquery","core/event","mod_astra/aplus_poll","theme_bootstrapbase/bootstrap"],function(a,b){return function(a,b,c,d,e){function f(b,c){this.element=a(b),this.settings=a.extend({},h,c),this.ajaxForms=!1,this.url=null,this.modalElement=null,this.loader=null,this.messages=null,this.quizSuccess=null,this.init()}var g="aplusChapter",h={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",loading_selector:"#loading-indicator",quiz_success_selector:"#quiz-success",message_selector:".progress-bar",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},modal_selector:"#page-modal"};a.extend(f.prototype,{init:function(){this.ajaxForms=!!c.FormData,this.url=this.element.attr(this.settings.chapter_url_attr),this.modalElement=a(this.settings.modal_selector),this.loader=a(this.settings.loader_selector),this.messages=this.readMessages(),this.quizSuccess=a(this.settings.quiz_success_selector),this.exercises=this.element.find("["+this.settings.exercise_url_attr+"]").aplusExercise(this),this.exercisesIndex=0,this.exercisesSize=this.exercises.size(),this.exercisesSize>0&&this.nextExercise()},nextExercise:function(){this.exercisesIndex<this.exercisesSize&&(this.exercises.eq(this.exercisesIndex).aplusExerciseLoad(),this.exercisesIndex++)},readMessages:function(){var a={},b=this.loader.find(this.settings.message_selector);for(var c in this.message_attr)a[c]=b.attr(this.message_attr[c]);return a},cloneLoader:function(b){return a(this.settings.loading_selector).clone().removeAttr("id").removeClass("hide")},openModal:function(a){this.modalElement.aplusModal("open",a)},modalError:function(a){this.modalElement.aplusModal("error",a)},modalContent:function(a){this.modalElement.aplusModal("content",{content:a}),this.moodleNotifyFilterContentUpdatedInModal()},modalSuccess:function(b,c){this.modalElement.one("hidden.bs.modal",function(c){a(d.body).animate({scrollTop:b.offset().top},300)});var e=this.quizSuccess.clone().attr("class",b.attr("class")).removeClass("exercise hide").removeAttr("id");e.find(".badge-placeholder").empty().append(c),c.hasClass("badge-success")||c.hasClass("badge-warning")?e.find(".btn-success").css("display","block"):e.find(".btn-success").hide(),this.modalContent(e)},moodleNotifyFilterContentUpdatedInModal:function(){b.notifyFilterContentUpdated(this.settings.modal_selector)}}),a.fn[g]=function(b){return this.each(function(){a.data(this,"plugin_"+g)||a.data(this,"plugin_"+g,new f(this,b))})}}(a,b,window,document),function(a,b,c,d,e){function f(b,c,d){this.element=a(b),this.chapter=c,this.settings=a.extend({},i,d),this.url=null,this.quiz=!1,this.ajax=!1,this.loader=null,this.messages={},this.init()}var g="aplusExercise",h="aplusExerciseLoad",i={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",content_element:'<div class="exercise-content"></div>',content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:'ul.nav a[class!="dropdown-toggle"]',dropdown_selector:"ul.nav .dropdown-toggle",last_submission_selector:"ul.nav ul.dropdown-menu li:first-child a"};a.extend(f.prototype,{init:function(){if(this.chapterID=this.element.attr("id"),this.url=this.element.attr(this.chapter.settings.exercise_url_attr),this.quiz=this.element.attr(this.settings.quiz_attr)!==e,this.ajax=this.element.attr(this.settings.ajax_attr)!==e,this.loader=this.chapter.cloneLoader(),this.element.height(this.element.height()).empty(),this.element.append(this.settings.content_element),this.element.append(this.loader),this.ajax){var b=this;c.addEventListener("message",function(c){"a-plus-refresh-stats"===c.data.type&&a.ajax(b.url,{dataType:"html"}).done(function(c){b.updateSummary(a(c))})})}},load:function(){this.showLoader("load");var b=this;a.ajax(this.url,{dataType:"html"}).fail(function(){b.showLoader("error"),b.chapter.nextExercise()}).done(function(c){b.hideLoader(),b.update(a(c)),b.quiz?b.loadLastSubmission(a(c)):(b.moodleNotifyFilterContentUpdated(),b.chapter.nextExercise())})},update:function(a){var b=this.element.find(this.settings.content_selector).empty().append(a.filter(this.settings.exercise_selector).contents());this.element.height("auto"),this.bindNavEvents(),this.bindFormEvents(b)},bindNavEvents:function(){this.chapter;this.element.find(this.settings.navigation_selector).filter(":not(.no-open-modal)").aplusModalLink(),this.element.find(this.settings.dropdown_selector).dropdown(),this.element.find(".page-modal").filter(":not(.no-open-modal)").aplusModalLink()},bindFormEvents:function(a){if(!this.ajax){var b=a.find("form").attr("action",this.url),d=this;this.chapter.ajaxForms&&b.on("submit",function(a){a.preventDefault(),d.submit(this)})}c.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submit:function(b){this.chapter.openModal(this.chapter.messages.submit);var c=this;a.ajax(a(b).attr("action"),{type:"POST",data:new FormData(b),contentType:!1,processData:!1,dataType:"html"}).fail(function(){this.chapter.modalError(c.chapter.messages.error)}).done(function(b){var d=a(b);if(c.quiz){var e=d.find(".badge").eq(2).clone();c.update(d),c.chapter.modalSuccess(c.element,e),c.moodleNotifyFilterContentUpdated()}else c.updateSubmission(d)})},updateSummary:function(a){this.element.find(this.settings.summary_selector).empty().append(a.find(this.settings.summary_selector).remove().contents()),this.bindNavEvents()},updateSubmission:function(b){if(this.updateSummary(b),this.chapter.modalContent(b.filter(this.settings.exercise_selector).contents()),"function"==typeof a.aplusExerciseDetectWaits){var c=this;a.aplusExerciseDetectWaits(function(b){a.ajax(b).done(function(b){var d=a(b),e=d.find(".badge"),f=c.element.find(c.settings.summary_selector+" .badge");f.eq(0).replaceWith(e.eq(0).clone()),f.eq(2).replaceWith(e.eq(1).clone());var g=d.filter(c.settings.exercise_selector).contents();""==g.text().trim()?c.chapter.modalSuccess(c.element,e.eq(2).clone()):c.chapter.modalContent(g)}).fail(function(){c.chapter.modalError(c.chapter.messages.error)})})}},loadLastSubmission:function(b){var c=b.find(this.settings.last_submission_selector);if(c.size()>0){var d=c.attr("href");if(d&&"#"!==d){this.showLoader("load");var e=this;a.ajax(c.attr("href"),{dataType:"html"}).fail(function(){e.showLoader("error"),e.chapter.nextExercise()}).done(function(b){e.hideLoader();var c=e.element.find(e.settings.response_selector).empty().append(a(b).filter(e.settings.exercise_selector).contents());e.bindFormEvents(c),e.moodleNotifyFilterContentUpdated(),e.chapter.nextExercise()})}else this.moodleNotifyFilterContentUpdated(),this.chapter.nextExercise()}else this.chapter.nextExercise()},showLoader:function(a){this.loader.show().find(this.settings.message_selector).text(this.chapter.messages[a]),"error"==a?this.loader.removeClass("active").addClass("progress-bar-danger"):this.loader.addClass("active").removeClass("progress-bar-danger")},hideLoader:function(){this.loader.hide()},moodleNotifyFilterContentUpdated:function(){b.notifyFilterContentUpdated("#"+this.element.attr("id"))}}),a.fn[g]=function(b,c){return this.each(function(){a.data(this,"plugin_"+g)||a.data(this,"plugin_"+g,new f(this,b,c))})},a.fn[h]=function(){return this.each(function(){var b=a.data(this,"plugin_"+g);b&&b.load()})}}(a,b,window,document),{}});