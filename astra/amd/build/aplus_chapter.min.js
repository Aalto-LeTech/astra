define(["jquery","core/event","mod_astra/aplus_poll","theme_boost/bootstrap/dropdown","mod_astra/aplus_modal"],function(e,t){function s(e,t){var s=void 0!==t.bubbles&&t.bubbles,i=void 0!==t.cancelable&&t.cancelable,a=void 0!==t.detail?t.detail:void 0,t=document.createEvent("CustomEvent");return t.initCustomEvent(e,s,i,a),t}var i;return"function"!=typeof window.CustomEvent&&(s.prototype=window.Event.prototype,window.CustomEvent=s),function(s,e,t){"use strict";var i="aplusChapter",a={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",active_element_attr:"data-aplus-active-element",loading_selector:"#loading-indicator",quiz_success_selector:"#quiz-success",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},modal_selector:"#page-modal"};function n(e,t){this.dom_element=e,this.element=s(e),this.settings=s.extend({},a,t),this.ajaxForms=!1,this.url=null,this.modalElement=null,this.loader=null,this.messages=null,this.quizSuccess=null,this.aeOutputs={},this.init()}s.extend(n.prototype,{init:function(){this.ajaxForms=!!t.FormData,this.url=this.element.attr(this.settings.chapter_url_attr),this.modalElement=s(this.settings.modal_selector),this.loader=s(this.settings.loading_selector),this.messages=this.readMessages(),this.quizSuccess=s(this.settings.quiz_success_selector),this.element.find("["+this.settings.active_element_attr+"='in']").aplusExercise(this,{input:!0});var e=this.element.find("["+this.settings.exercise_url_attr+"]");0<e.length?(this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-loaded",{bubbles:!0})),e.aplusExercise(this),this.exercises=e,this.exercisesIndex=0,this.exercisesSize=e.length,this.nextExercise()):(e="text/x.aplus-exercise",this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:e}})),this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:e}})))},nextExercise:function(){this.exercisesIndex<this.exercisesSize&&(this.exercises.eq(this.exercisesIndex).aplusExerciseLoad(),this.exercisesIndex++),this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-ready",{bubbles:!0}))},readMessages:function(){var e,t={};for(e in this.settings.message_attr)t[e]=this.loader.attr(this.settings.message_attr[e]);return t},cloneLoader:function(e){return s(this.settings.loading_selector).clone().removeAttr("id").show()},openModal:function(e){this.modalElement.aplusModal("open",e)},modalError:function(e){this.modalElement.aplusModal("error",e)},modalContent:function(e){this.modalElement.aplusModal("content",{content:e}),this.renderMath()},modalSuccess:function(e,t){e=this.quizSuccess.clone().attr("class",e.attr("class")).removeClass("exercise").removeAttr("id").show();e.find(".badge-placeholder").empty().append(t),t.hasClass("badge-success")||t.hasClass("badge-warning")?e.find(".btn-success").css("display","block"):e.find(".btn-success").hide(),this.modalContent(e)},renderMath:function(){e.notifyFilterContentUpdated(this.settings.modal_selector)}}),s.fn[i]=function(e){return this.each(function(){s.data(this,"plugin_"+i)||s.data(this,"plugin_"+i,new n(this,e))})}}(e,t,window,document),function(d,e,s,i){"use strict";var a="aplusExercise",n={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",content_element:'<div class="exercise-content"></div>',content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:'ul.exercise-nav a[class!="dropdown-toggle"]',dropdown_selector:"ul.exercise-nav .dropdown-toggle",last_submission_selector:"ul.exercise-nav .dropdown-menu a:first-child",active_element_attr:"data-aplus-active-element",ae_result_selector:".ae_result",input:!1,submission_point_badges_selector:"[data-points-badge] .badge"};function r(e,t,s){this.dom_element=e,this.element=d(e),this.chapter=t,this.settings=d.extend({},n,s),this.url=null,this.quiz=!1,this.ajax=!1,this.active_element=!1,this.loader=null,this.messages={},this.init()}d.extend(r.prototype,{init:function(){var t;this.chapterID=this.element.attr("id"),this.url=this.element.attr(this.chapter.settings.exercise_url_attr),this.quiz=this.element.attr(this.settings.quiz_attr)!==i,this.ajax=this.element.attr(this.settings.ajax_attr)!==i,this.active_element=this.element.attr(this.settings.active_element_attr)!==i,this.exercise_type=this.quiz?"text/x.aplus-exercise.quiz.v1":this.ajax?"text/x.aplus-exercise.iframe.v1":this.active_element?"text/x.aplus-exercise.active-element.v1":"text/x.aplus-exercise",this.active_element&&!this.settings.input&&(this.chapter.aeOutputs[this.chapterID]=this),this.loader=this.chapter.cloneLoader(),this.element.height(this.element.height()).empty(),this.element.append(this.settings.content_element),this.element.append(this.loader),this.settings.input&&this.load(),!this.active_element&&this.ajax&&(t=this,s.addEventListener("message",function(e){"a-plus-refresh-stats"===e.data.type&&d.ajax(t.url,{dataType:"html"}).done(function(e){t.updateSummary(d(e))})}))},makeInputForm:function(e,t,s,i){var a=d("<div>");a.attr("id","exercise-all");var n=d("<form>");n.attr("action",""),n.attr("method","post");var r=d("<div>");r.attr("class","form-group");var l,o=d("<label>");o.attr("class","control-label"),o.attr("for",e+"_input"),o.html(t),s&&"clickable"!==s?"file"===s?((l=d("<input>")).attr("type","file"),n.attr("enctype","multipart/form-data")):"dropdown"==s.substring(0,8)&&(l=d("<select>"),s=s.split(":").pop().split(","),d.each(s,function(e,t){var s=d("<option>");s.text(t),s.val(t),l.append(s)})):(l=d("<textarea>")).val(i),l.attr("class","form-control"),l.attr("id",e+"_input_id"),l.attr("name",e+"_input");i=d("<div>");r.attr("class","form-group");e=d("<input>");return e.attr("class","btn btn-primary"),e.attr("value","Submit"),e.attr("type","submit"),d(r).append(o,l),d(i).append(e),d(n).append(r,i),d(a).append(n),d(a)},load:function(t){this.showLoader("load");var e,s,i,a=this;a.settings.input?(s=a.element.data("title"),e=a.element.data("type"),s=s||"",i=(i=a.element.data("default"))||"",a.hideLoader(),i=a.makeInputForm(a.chapterID,s,e,i),a.update(i),a.loadLastSubmission(i),t||a.chapter.nextExercise()):d.ajax(this.url,{dataType:"html"}).fail(function(){a.showLoader("error"),t||a.chapter.nextExercise()}).done(function(e){a.hideLoader(),a.update(d(e)),a.quiz||a.active_element?a.loadLastSubmission(d(e)):(a.renderMath(),t||a.chapter.nextExercise())})},update:function(e){var t=this;e=e.filter(t.settings.exercise_selector).contents();var s=t.element.find(t.settings.content_selector).empty().append(e).hide();this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:this.exercise_type}})),t.active_element&&(i="",t.element.attr("data-title")&&(i="<p><b>"+t.element.attr("data-title")+"</b></p>"),t.element.find(t.settings.summary_selector).remove(),d(i).prependTo(t.element.find(t.settings.response_selector))),s.show();var i,e=t.element.css("height");t.active_element&&(t.settings.input?d("#"+t.chapterID+" textarea").css("height",e):void 0!==d("#"+t.chapterID).data("scale")?(i=d(t.settings.ae_result_selector,t.element)[0].scrollHeight,d(t.settings.ae_result_selector,t.element).css({height:i+"px"})):d(t.settings.ae_result_selector,t.element).css("height",e)),this.element.height("auto"),this.bindNavEvents(),this.bindFormEvents(s),this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:this.exercise_type}}))},bindNavEvents:function(){this.element.find(this.settings.navigation_selector).aplusModalLink(),this.element.find(this.settings.dropdown_selector).dropdown(),this.element.find(".page-modal").aplusModalLink()},bindFormEvents:function(e){var t;this.ajax||(e=e.find("form").attr("action",this.url),(t=this).chapter.ajaxForms&&e.on("submit",function(e){e.preventDefault(),t.submit(this)})),s.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submitAjax:function(i,a,n,r){var l=this;d.ajax(i,{type:"POST",data:a,contentType:!1,processData:!1,dataType:"html"}).fail(function(e,t,s){r=r||0,200!==e.status&&r<5&&setTimeout(function(){l.submitAjax(i,a,n,r+1)},100),l.active_element?((e=d("<div>")).attr("id","feedback"),e.append(l.chapter.messages.error),l.updateOutput(e)):(l.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:l.exercise_type}})),l.chapter.modalError(l.chapter.messages.error))}).done(function(e){n(e)})},collectFormData:function(e,t){e=d(e);var s=this.matchInputs(e),i=s[0],e=s[1],n=s[2],r=new FormData,l=this.chapterID,o=!0;return d.each(e,function(e,t){var s,i=d.find("#"+t),a=d("#"+t+"_input_id");if(i[0].hasAttribute("data-inputs")){if(d(i).data("evaluating"))return void(r=o=!1);s=d(i).find(".ae_result").text().trim()}else"file"===d(i).data("type")?s=a.get(0).files[0]:t!==l?(s=a.val(),d(i).data("value")&&(s=d(i).data("value")),a.val(s)):(s=a.val(),d(i).data("value",s));s||(o=!1),r&&r.append(n[e],s)}),[i,o,r]},submit:function(l){var s,e,t,o=this,i=this.chapter;this.active_element?(e=this.chapterID,t=d.find('[data-inputs~="'+e+'"]'),d.each(t,function(e,t){var s=o.collectFormData(t,l),i=s[0],a=s[1],n=s[2],t=i.chapterID,r=d("#"+t),s=r.find(i.settings.ae_result_selector);if(a||n){if(!a)return d("#"+t).find(i.settings.ae_result_selector).html('<p style="color:red;">Fill out all the inputs</p>'),void o.dom_element.dispatchEvent(new CustomEvent("aplus:submission-aborted",{bubbles:!0,detail:{type:o.exercise_type}}));r.data("evaluating",!0),void 0!==r.data("scale")&&s.css({height:s.height()}),s.html("<p>Evaluating</p>");s=i.url;i.submitAjax(s,n,function(e){var t,s=d(e);s.find(".alert-danger").length?0<=s.find(".alert-danger").contents().text().indexOf("The grading queue is not configured.")?(r.find(i.settings.ae_result_selector).html(s.find(".alert").text()),r.find(i.settings.ae_result_selector).append(s.find(".grading-task").text())):r.find(i.settings.ae_result_selector).html(s.find(".alert-danger").contents()):(e=(t=s.find(".exercise-wait")).attr("data-poll-url"),t=t.attr("data-ready-url"),r.attr("data-poll-url",e),r.attr("data-ready-url",t),i.updateSubmission(s))})}})):(i.openModal(i.messages.submit),s=this,e=d(l).attr("action"),t=new FormData(l),s.submitAjax(e,t,function(e){var t=d(e);s.quiz?(e=t.find(".badge").eq(2).clone(),s.update(t),i.modalSuccess(s.element,e),s.renderMath(),s.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:s.exercise_type}}))):s.updateSubmission(t)}))},matchInputs:function(e){var t=e.attr("id"),s=this.chapter.aeOutputs[t],t=e.attr("data-inputs").split(" "),e=e.find(s.settings.ae_result_selector).attr("data-expected-inputs");return[s,t,e=e?(e=e.trim().split(" "),d.grep(e,function(e){return""!==e||"\n"!==e})):[]]},updateSummary:function(e){this.element.find(this.settings.summary_selector).empty().append(e.find(this.settings.summary_selector).remove().contents()),this.bindNavEvents()},updateSubmission:function(e){var i,t;this.active_element||(this.updateSummary(e),this.chapter.modalContent(e.filter(this.settings.exercise_selector).contents())),"function"==typeof d.aplusExerciseDetectWaits&&((i=this).active_element&&(t="#"+this.chapterID),d.aplusExerciseDetectWaits(function(e,t){t?i.active_element?i.dispatchEventToActiveElem("aplus:exercise-submission-failure"):(i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:i.exercise_type}})),i.load(!0)):d.ajax(e).done(function(e){var t,s;i.active_element?(i.updateOutput(e),i.dispatchEventToActiveElem("aplus:submission-finished"),i.submit()):(t=(s=d(e)).find(i.settings.submission_point_badges_selector),(e=i.element.find(i.settings.summary_selector+" .badge")).eq(0).replaceWith(t.eq(0).clone()),e.eq(2).replaceWith(t.eq(1).clone()),""==(s=s.filter(i.settings.exercise_selector).contents()).text().trim()?i.chapter.modalSuccess(i.element,t.eq(1).clone()):i.chapter.modalContent(s),i.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:i.exercise_type}})),i.load(!0))}).fail(function(){i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:i.exercise_type}})),i.chapter.modalError(i.chapter.messages.error),i.load(!0)})},t)||i.load(!0))},updateOutput:function(e){var t=this,s=t.element.attr("data-type")||"text",e=d(e);e.is("#feedback")||(e=e.find("#feedback")),"text"==s?e=e.text():"image"==s&&(e='<img src="data:image/png;base64, '+e.text()+'" />');s=t.element.find(t.settings.ae_result_selector);s.html(e),t.element.data("evaluating",!1),void 0!==t.element.data("scale")&&s.css({height:"auto"})},updateInputs:function(e){e=e.submission_data;var t,s,i,a=this.matchInputs(this.element),n=(a[0],a[1]),r=a[2];for(t in e)e.hasOwnProperty(t)&&(s=n[d.inArray(t,r)],i=e[t],"file"!==d("#"+s).data("type")&&(d(d.find("#"+s)).data("value",i),d("#"+s+"_input_id").val(i).trigger("change")))},dispatchEventToActiveElem:function(e){this.dom_element.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{type:this.exercise_type}}));for(var t=this.matchInputs(this.element)[1],s=0;s<t.length;++s){var i=t[s],i=d("#"+i).data("plugin_"+a);i&&i.dom_element.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{type:i.exercise_type}}))}},loadLastSubmission:function(e){var t,s=e.find(this.settings.last_submission_selector),i=this;0<s.length&&((t=s.attr("href"))&&"#"!==t?(e="html",i.active_element&&((s=t.match(/submission\.php\?id=(\d+)$/))?(t="submission_data.php?id="+s[1],e="json"):console.error("Can not read the submission data URL")),this.showLoader("load"),d.ajax(t,{dataType:e}).fail(function(){i.showLoader("error")}).done(function(e){i.hideLoader(),i.active_element?(i.updateOutput(e.feedback),i.updateInputs(e)):(i.element.find(i.settings.response_selector).empty().append(d(e).filter(i.settings.exercise_selector).contents()),i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:i.exercise_type}})),i.bindFormEvents(i.element),i.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:i.exercise_type}}))),i.renderMath()})):i.renderMath()),i.chapter.nextExercise()},showLoader:function(e){this.loader.show().find(this.settings.message_selector).text(this.chapter.messages[e]),"error"==e?this.loader.removeClass("progress-bar-animated").addClass("bg-danger"):this.loader.addClass("progress-bar-animated").removeClass("bg-danger")},hideLoader:function(){this.loader.hide()},renderMath:function(){e.notifyFilterContentUpdated("#"+this.element.attr("id"))}}),d.fn[a]=function(e,t){return this.each(function(){d.data(this,"plugin_"+a)||d.data(this,"plugin_"+a,new r(this,e,t))})},d.fn.aplusExerciseLoad=function(){return this.each(function(){var e=d.data(this,"plugin_"+a);e&&e.load()})}}(e,t,window,void document),(i=e)(document).on("aplus:exercise-loaded",function(e){i(e.target).find("form").each(function(){var e=i(this);"post"==e.prop("method")&&e.on("submit",function(e){i(this).find('[type="submit"]').prop("disabled",!0).attr("data-aplus-submit-disabled","yes")})})}),i(document).on("aplus:exercise-submission-failure aplus:submission-finished aplus:submission-aborted",function(e){i(e.target).find("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")}),i(document).on("hidden.bs.modal",function(e){i("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")}),{}});