/**
 * A+ select widget (multiple select with search and remove) as an AMD module for Moodle.
 * In an HTML page, run the following JS code once to activate it:
 * $('.search-select').aplusSearchSelect();
 * (The targeted element should be a <select> element.)
 * 
 * Source: A+ (a-plus/assets/js/aplus.js)
 * License: GNU GPL v3
 * 
 * @module mod_astra/aplus_searchselect
 */
define(["jquery"],function(a){return function(a,b,c,d){"use strict";function e(b,c){this.element=a(b),this.timeout=null,"SELECT"==this.element.prop("tagName")&&this.element.prop("multiple")&&(this.settings=a.extend({},g,c),this.init())}var f="aplusSearchSelect",g={widget_selector:"#search-select-widget",field_selector:'input[type="text"]',search_selector:".dropdown-toggle",result_selector:".search-options",selection_selector:".search-selected"};a.extend(e.prototype,{init:function(){this.widget=a(this.settings.widget_selector).clone().removeAttr("id").removeClass("hide").insertBefore(this.element),this.element.hide();var b=this;this.selection=this.widget.find(this.settings.selection_selector),this.selection_li=this.selection.find("li").remove(),this.element.find("option:selected").each(function(c){b.add_selection(a(this).attr("value"),a(this).text())}),this.result=this.widget.find(this.settings.result_selector),this.field=this.widget.find(this.settings.field_selector).on("keypress",function(a){13==a.keyCode&&(a.preventDefault(),b.search_options(!0))}).on("keyup",function(a){13!=a.keyCode&&(clearTimeout(b.timeout),b.timeout=setTimeout(function(){b.search_options(!0),b.field.focus()},500))}),this.search=this.widget.find(this.settings.search_selector).on("show.bs.dropdown",function(a){b.search_options()}),this.element.parents("form").on("submit",function(a){b.finish()})},search_options:function(b){if(b&&this.result.is(":visible")===!1)return void this.search.find("button").dropdown("toggle");this.result.find("li:not(.not-found)").remove(),this.result.find("li.not-found").hide();var c="option",d=this.field.val().trim();d.length>0&&(c+=":contains("+this.field.val()+")");var e=this.element.find(c);if(0===e.size())this.result.find("li.not-found").show();else{var f=this;e.slice(0,20).each(function(b){var c=a('<li><a data-value="'+a(this).attr("value")+'">'+a(this).text()+"</a></li>");c.find("a").on("click",function(b){f.add_selection(a(this).attr("data-value"),a(this).text())}),f.result.append(c)})}},add_selection:function(b,c){if(0===this.selection.find('[data-value="'+b+'"]').size()){var d=this.selection_li.clone();d.find(".name").text(c),d.find("button").attr("data-value",b).on("click",function(b){a(this).parent("li").remove()}),this.selection.append(d)}},finish:function(){this.widget.remove();var b=this.element.show();b.find("option:selected").prop("selected",!1),this.selection.find("button").each(function(c){b.find('option[value="'+a(this).attr("data-value")+'"]').prop("selected",!0)})}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(a,window,document),{}});